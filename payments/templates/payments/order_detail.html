{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Order {{ order.id }}</title>
    <script src="https://js.stripe.com/v3/"></script>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
    <h1>Order {{ order.id }}</h1>
    {% if order.order_items.exists %}
        <ul>
        {% for order_item in order.order_items.all %}
            <li>{{ order_item.quantity }} x {{ order_item.item.name }} - {{ order_item.get_subtotal }} {{ order.get_currency|upper }}</li>
        {% endfor %}
        </ul>
    {% else %}
        <p>No items in this order.</p>
    {% endif %}
    <p><strong>Total:</strong> {{ order.get_total_price }} {{ order.get_currency|upper }}</p>
    {% if order.discount %}
        <p>Discount: {{ order.discount.percentage }}%</p>
    {% endif %}
    {% if order.tax %}
        <p>Tax: {{ order.tax.percentage }}%</p>
    {% endif %}
    <button onclick="buyOrder()">Buy</button>

    <a href="{% url 'home' %}">Back to Home</a>
    <script>
        const stripe = Stripe('{{ stripe_public_key }}');
        function buyOrder() {
            fetch('/buy-order/{{ order.id }}/', {
                method: 'GET',
            })
            .then(response => response.json())
            .then(data => {
                if (data.sessionId) {
                    stripe.redirectToCheckout({ sessionId: data.sessionId });
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => alert('Error: ' + error));
        }
    </script>
</body>
</html>